<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <title>zhang_231</title>
        <link type="text/css" rel="stylesheet" href="appbase.css">
    </head>
    <body class="wikidpad">
<span class="wikidpad wiki-name-ref">[<a name="$8bbe$8ba1$6587$6863" class="wikidpad">设计文档</a>]<br class="wikidpad" /><br class="wikidpad" /></span><span class="wikidpad parent-nodes">parent nodes: <br class="wikidpad" /></span><a name="$8bbe$8ba1$6587$6863#.h0" class="wikidpad"></a><h2 class="wikidpad heading-level2">月光宝盒离线计算设计文档</h2>
<div class="wikidpad page-toc">
<div class="wikidpad page-toc-level2"><a href="#$8bbe$8ba1$6587$6863#.h0" class="wikidpad">月光宝盒离线计算设计文档</a></div>
<div class="wikidpad page-toc-level3"><a href="#$8bbe$8ba1$6587$6863#.h470" class="wikidpad">1.参考资料</a></div>
<div class="wikidpad page-toc-level3"><a href="#$8bbe$8ba1$6587$6863#.h573" class="wikidpad">2.离线部署</a></div>
<div class="wikidpad page-toc-level3"><a href="#$8bbe$8ba1$6587$6863#.h645" class="wikidpad">3.任务部署调度流程</a></div>
<div class="wikidpad page-toc-level3"><a href="#$8bbe$8ba1$6587$6863#.h692" class="wikidpad">4.数据交互</a></div>
<div class="wikidpad page-toc-level3"><a href="#$8bbe$8ba1$6587$6863#.h772" class="wikidpad">5.数据计算调度模块</a></div>
<div class="wikidpad page-toc-level3"><a href="#$8bbe$8ba1$6587$6863#.h1163" class="wikidpad">6.用户轨迹全息图构建和染色</a></div>
<div class="wikidpad page-toc-level3"><a href="#$8bbe$8ba1$6587$6863#.h1203" class="wikidpad">7.效果指标归属逻辑</a></div>
<div class="wikidpad page-toc-level4"><a href="#$8bbe$8ba1$6587$6863#.h1445" class="wikidpad">7.1.流量指标</a></div>
<div class="wikidpad page-toc-level4"><a href="#$8bbe$8ba1$6587$6863#.h1493" class="wikidpad">7.2.成交归属逻辑</a></div>
<div class="wikidpad page-toc-level4"><a href="#$8bbe$8ba1$6587$6863#.h1531" class="wikidpad">7.3.收藏归属逻辑</a></div>
<div class="wikidpad page-toc-level4"><a href="#$8bbe$8ba1$6587$6863#.h1559" class="wikidpad">7.4.购物车归属逻辑</a></div>
<div class="wikidpad page-toc-level4"><a href="#$8bbe$8ba1$6587$6863#.h1588" class="wikidpad">7.5.淘外成交归属逻辑（仅etao有此需求）</a></div>
<div class="wikidpad page-toc-level4"><a href="#$8bbe$8ba1$6587$6863#.h1733" class="wikidpad">7.6.返利数据归属逻辑（需求实现，此处仅作为文档记录）</a></div>
<div class="wikidpad page-toc-level3"><a href="#$8bbe$8ba1$6587$6863#.h2093" class="wikidpad">8.核心计算模块（构建全息图，染色，归属）</a></div>
<div class="wikidpad page-toc-level4"><a href="#$8bbe$8ba1$6587$6863#.h2219" class="wikidpad">8.0.输入和输出的规定</a></div>
<div class="wikidpad page-toc-level4"><a href="#$8bbe$8ba1$6587$6863#.h6106" class="wikidpad">8.1.hadoop任务之间数据交互规则</a></div>
<div class="wikidpad page-toc-level4"><a href="#$8bbe$8ba1$6587$6863#.h8985" class="wikidpad">8.2.单元测试</a></div>
<div class="wikidpad page-toc-level4"><a href="#$8bbe$8ba1$6587$6863#.h9027" class="wikidpad">8.3.调度使用方法</a></div>
<div class="wikidpad page-toc-level4"><a href="#$8bbe$8ba1$6587$6863#.h9285" class="wikidpad">8.4.特殊指标定义</a></div>
<div class="wikidpad page-toc-level4"><a href="#$8bbe$8ba1$6587$6863#.h9508" class="wikidpad">8.5.详细计算流程</a></div>
<div class="wikidpad page-toc-level5"><a href="#$8bbe$8ba1$6587$6863#.h9524" class="wikidpad">job1:URL MATCHER &amp; Forest &amp; Colorized</a></div>
<div class="wikidpad page-toc-level5"><a href="#$8bbe$8ba1$6587$6863#.h10079" class="wikidpad">job2:EFFECT OWNERSHIP</a></div>
<div class="wikidpad page-toc-level4"><a href="#$8bbe$8ba1$6587$6863#.h10578" class="wikidpad">8.6:性能优化方案 </a></div>
<div class="wikidpad page-toc-level3"><a href="#$8bbe$8ba1$6587$6863#.h10816" class="wikidpad">9.数据计算</a></div>
<div class="wikidpad page-toc-level5"><a href="#$8bbe$8ba1$6587$6863#.h10857" class="wikidpad">9.1.ETL操作</a></div>
<div class="wikidpad page-toc-level5"><a href="#$8bbe$8ba1$6587$6863#.h11635" class="wikidpad">9.2 输出中间表</a></div>
<div class="wikidpad page-toc-level5"><a href="#$8bbe$8ba1$6587$6863#.h11693" class="wikidpad">9.3.效果指标计算</a></div>
<div class="wikidpad page-toc-level5"><a href="#$8bbe$8ba1$6587$6863#.h12008" class="wikidpad">9.4. 广告点击数据处理</a></div>
<div class="wikidpad page-toc-level5"><a href="#$8bbe$8ba1$6587$6863#.h12596" class="wikidpad">9.5. 广告数据mysql入库</a></div>
<div class="wikidpad page-toc-level5"><a href="#$8bbe$8ba1$6587$6863#.h12910" class="wikidpad">9.6. 结果数据导入到hbase</a></div>
<div class="wikidpad page-toc-level3"><a href="#$8bbe$8ba1$6587$6863#.h13174" class="wikidpad">10.SPM信息</a></div>
</div>
<br class="wikidpad" />
<ul class="wikidpad bulletlist">
<li class="wikidpad" />整体设计参见清无文档，此文档仅描述离线自身部分内容。<span class="wikidpad url-link"><a href="http://red.lzdp.us/projects/effect-platform/wiki/Effect_Sprint1_Detail_Design" class="wikidpad">http://red.lzdp.us/projects/effect-platform/wiki/Effect_Sprint1_Detail_Design</a></span>
<li class="wikidpad" />hadoop根目录位置为：hdfs_base_dir=/group/tbads/sds/linezing/effect_platform
<li class="wikidpad" />一期不足和遗留未做功能：<ul class="wikidpad bulletlist">
<li class="wikidpad" />只提供一天效果的计算，不支持多天效果
<li class="wikidpad" />不支持按照4淘日志切分进行数据计算
<li class="wikidpad" />同优先级来源效果归属规则中平均归属equal，不提供支持
<li class="wikidpad" />2.0: 代码都在svn，考虑迁移到git
<li class="wikidpad" />其他来源，其他路径计算和产品需求不符合
<li class="wikidpad" />店铺收藏指标目前无法计算
<li class="wikidpad" />下线任务，上线任务 只判断昨天？这个是不是有问题
<li class="wikidpad" />多plan同时跑的问题？<br class="wikidpad" />
</ul>
</ul>
<a name="$8bbe$8ba1$6587$6863#.h470" class="wikidpad"></a><h3 class="wikidpad heading-level3">1.参考资料</h3>
<ul class="wikidpad bulletlist">
<li class="wikidpad" />清无设计文档：<span class="wikidpad url-link"><a href="http://red.lzdp.us/projects/effect-platform/wiki/Effect_Sprint1_Detail_Design" class="wikidpad">http://red.lzdp.us/projects/effect-platform/wiki/Effect_Sprint1_Detail_Design</a></span><br class="wikidpad" />
</ul>
<a name="$8bbe$8ba1$6587$6863#.h573" class="wikidpad"></a><h3 class="wikidpad heading-level3">2.离线部署</h3>
<ul class="wikidpad bulletlist">
<li class="wikidpad" />参见'清无设计文档' 1.2节
<li class="wikidpad" />lz_effect_platform_start为天网起始节点<br class="wikidpad" />
</ul>
<a name="$8bbe$8ba1$6587$6863#.h645" class="wikidpad"></a><h3 class="wikidpad heading-level3">3.任务部署调度流程</h3>
<img src="离线任务部署流程.png"></img><br class="wikidpad" />
<br class="wikidpad" />
<a name="$8bbe$8ba1$6587$6863#.h692" class="wikidpad"></a><h3 class="wikidpad heading-level3">4.数据交互</h3>
<ul class="wikidpad bulletlist">
<li class="wikidpad" />参见'清无设计文档' ５节
<li class="wikidpad" />包括三部分：配置文件获取，数据产出入HBASE，广告信息datax直接入mysql<br class="wikidpad" />
</ul>
<a name="$8bbe$8ba1$6587$6863#.h772" class="wikidpad"></a><h3 class="wikidpad heading-level3">5.数据计算调度模块</h3>
<ol class="wikidpad orderedlist">
<li class="wikidpad" />新plan自动运行：<ul class="wikidpad bulletlist">
<li class="wikidpad" />每天从/home/lz/effect_platform/conf/report/%(YYYY)s/%(MM)s/%(DD)s得到新审批通过的配置文件，上传到云梯/group/tbads/sds/linezing/effect_platform/hadoop/effect_platform_mid/%(YYYYMMDD)%/1(效果归属周期，目前只支持1)/none(计算范围，目前只支持none)
<li class="wikidpad" />程序执行时，遍历所有plan文件，并行启动任务。</ul>

<li class="wikidpad" />plan自动下线<ul class="wikidpad bulletlist">
<li class="wikidpad" />每天从/home/lz/effect_platform/conf/overdue/%(YYYY)s/%(MM)s/%(DD)s得到需要下线的配置文件，从云梯目录删除对应文件。<br class="wikidpad" />
</ul>
</ol>
<a name="$8bbe$8ba1$6587$6863#.h1163" class="wikidpad"></a><h3 class="wikidpad heading-level3">6.用户轨迹全息图构建和染色</h3>
<ul class="wikidpad bulletlist">
<li class="wikidpad" />参见'清无设计文档' 3节<br class="wikidpad" />
</ul>
<a name="$8bbe$8ba1$6587$6863#.h1203" class="wikidpad"></a><h3 class="wikidpad heading-level3">7.效果指标归属逻辑</h3>
<ul class="wikidpad bulletlist">
<li class="wikidpad" />染色：用户轨迹全息图中符合路径规则的后续访问节点。
<li class="wikidpad" />引导宝贝/店铺页面：效果页后续访问的第一个店内页面。
<li class="wikidpad" />归属优先级：用户指定路径的优先级，数值越小优先级越高。
<li class="wikidpad" />归属顺序：last, first, all, equal(不支持)。其中last, first是按照归属点的时间戳时间判定。<ul class="wikidpad bulletlist">
<li class="wikidpad" />归属点：用户指定的路径中的某一跳。用此节点时间戳作为路径的时间戳进行比较。（1.0默认为效果页）</ul>
</ul>
<a name="$8bbe$8ba1$6587$6863#.h1445" class="wikidpad"></a><h4 class="wikidpad heading-level4">7.1.流量指标</h4>
<ul class="wikidpad bulletlist">
<li class="wikidpad" />用户访问路径内染色的节点认为是流量效果节点，进行计算。</ul>
<a name="$8bbe$8ba1$6587$6863#.h1493" class="wikidpad"></a><h4 class="wikidpad heading-level4">7.2.成交归属逻辑</h4>
<ul class="wikidpad bulletlist">
<li class="wikidpad" />参见'清无设计文档' 4.3节</ul>
<a name="$8bbe$8ba1$6587$6863#.h1531" class="wikidpad"></a><h4 class="wikidpad heading-level4">7.3.收藏归属逻辑</h4>
<ul class="wikidpad bulletlist">
<li class="wikidpad" />同成交逻辑</ul>
<a name="$8bbe$8ba1$6587$6863#.h1559" class="wikidpad"></a><h4 class="wikidpad heading-level4">7.4.购物车归属逻辑</h4>
<ul class="wikidpad bulletlist">
<li class="wikidpad" />同成交逻辑</ul>
<a name="$8bbe$8ba1$6587$6863#.h1588" class="wikidpad"></a><h4 class="wikidpad heading-level4">7.5.淘外成交归属逻辑（仅etao有此需求）</h4>
<ul class="wikidpad bulletlist">
<li class="wikidpad" />对etao浏览日志url进行trade_track_info的提取
<li class="wikidpad" />成交表：s_dw_sh_etao_pay_order, 取相同trade_track_info的数据，按照时间戳顺序归属给最近的浏览日志。</ul>
<a name="$8bbe$8ba1$6587$6863#.h1733" class="wikidpad"></a><h4 class="wikidpad heading-level4">7.6.返利数据归属逻辑（需求实现，此处仅作为文档记录）</h4>
<ul class="wikidpad bulletlist">
<li class="wikidpad" />返利成交表: s_dw_etao_cps_order 中返利数据( is_settle=1 and gmv_num&gt;0) , 包含 亿起发(source=1) 站外B2C(source=4) 和淘客(source=2)  这三种类型.
<li class="wikidpad" />亿起发和站外B2C 都是站外引导<ul class="wikidpad bulletlist">
<li class="wikidpad" />归属时使用etao浏览日志url提取出的 trade_track_info 字段。 成交浏览trade_track_info相同数据，按找时间戳顺序归属给最近的浏览日志。</ul>

<li class="wikidpad" />淘客 属于 站内效果,归属时使用买家user_id<ul class="wikidpad bulletlist">
<li class="wikidpad" />按照user_id，按时间戳归属给宝贝浏览页面的user_id相同的浏览记录<br class="wikidpad" />
<br class="wikidpad" />
</ul>
</ul>
<a name="$8bbe$8ba1$6587$6863#.h2093" class="wikidpad"></a><h3 class="wikidpad heading-level3">8.核心计算模块（构建全息图，染色，归属）</h3>
<ul class="wikidpad bulletlist">
<li class="wikidpad" />核心模块使用MR任务进行开发，部分计算使用后端实时提供接口共用。
<li class="wikidpad" />功能描述：完成用户全息轨迹图的构建，归属用户来源路径匹配规则，完成染色
<li class="wikidpad" />需要参考章节：2，3，4</ul>
<a name="$8bbe$8ba1$6587$6863#.h2219" class="wikidpad"></a><h4 class="wikidpad heading-level4">8.0.输入和输出的规定</h4>
<ol class="wikidpad orderedlist">
<li class="wikidpad" />最小输入单元<ol class="wikidpad orderedlist">
<li class="wikidpad" />流量access日志<br class="wikidpad" />
<table border="2" class="wikidpad">
<tr class="wikidpad"><td class="wikidpad"><b class="wikidpad">字段名称</b> </td><td class="wikidpad"><b class="wikidpad">字段类型</b> </td><td class="wikidpad"><b class="wikidpad">字段说明</b></td></tr>
<tr class="wikidpad"><td class="wikidpad">timestamp </td><td class="wikidpad">bigint </td><td class="wikidpad">时间戳h</td></tr>
<tr class="wikidpad"><td class="wikidpad">url </td><td class="wikidpad">string </td><td class="wikidpad"></td></tr>
<tr class="wikidpad"><td class="wikidpad">refer_url </td><td class="wikidpad">string </td><td class="wikidpad"></td></tr>
<tr class="wikidpad"><td class="wikidpad">shop_id </td><td class="wikidpad">string </td><td class="wikidpad">店铺ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">auction_id </td><td class="wikidpad">string </td><td class="wikidpad">宝贝ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">user_id </td><td class="wikidpad">string </td><td class="wikidpad">访客ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">cookie </td><td class="wikidpad">string </td><td class="wikidpad">cookie用来标识一个访问用户（atpanle日志中用mid）</td></tr>
<tr class="wikidpad"><td class="wikidpad">session </td><td class="wikidpad">string </td><td class="wikidpad">一次会话的标识（atpanle日志中用sid）</td></tr>
<tr class="wikidpad"><td class="wikidpad">cookie2 </td><td class="wikidpad">string </td><td class="wikidpad">用来计算uv使用（atpanle日志中用mid_uid, 其他情况直接使用cookie）</td></tr>
</table>

<li class="wikidpad" />成交trade日志<br class="wikidpad" />
<table border="2" class="wikidpad">
<tr class="wikidpad"><td class="wikidpad"><b class="wikidpad">字段名称</b> </td><td class="wikidpad"><b class="wikidpad">字段类型</b> </td><td class="wikidpad"><b class="wikidpad">字段说明</b></td></tr>
<tr class="wikidpad"><td class="wikidpad">gmv_trade_timestamp </td><td class="wikidpad">bigint </td><td class="wikidpad">拍下时间戳</td></tr>
<tr class="wikidpad"><td class="wikidpad">shop_id </td><td class="wikidpad">string </td><td class="wikidpad">店铺ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">auction_id </td><td class="wikidpad">string </td><td class="wikidpad">宝贝ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">user_id </td><td class="wikidpad">string </td><td class="wikidpad">访客ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">ali_corp </td><td class="wikidpad">bigint </td><td class="wikidpad">网站类型（0 未知或非阿里系 1 淘宝 2 天猫 3 一淘 4 聚划算）</td></tr>
<tr class="wikidpad"><td class="wikidpad">gmv_trade_num </td><td class="wikidpad">int </td><td class="wikidpad">拍下笔数</td></tr>
<tr class="wikidpad"><td class="wikidpad">gmv_trade_amt </td><td class="wikidpad">float </td><td class="wikidpad">拍下金额</td></tr>
<tr class="wikidpad"><td class="wikidpad">gmv_auction_num </td><td class="wikidpad">int </td><td class="wikidpad">拍下件数</td></tr>
<tr class="wikidpad"><td class="wikidpad">alipay_trade_num </td><td class="wikidpad">int </td><td class="wikidpad">成交比数</td></tr>
<tr class="wikidpad"><td class="wikidpad">alipay_trade_amt </td><td class="wikidpad">float </td><td class="wikidpad">成交金额</td></tr>
<tr class="wikidpad"><td class="wikidpad">alipay_auction_num </td><td class="wikidpad">int </td><td class="wikidpad">成交件数</td></tr>
</table>

<li class="wikidpad" />收藏collect日志<br class="wikidpad" />
<table border="2" class="wikidpad">
<tr class="wikidpad"><td class="wikidpad"><b class="wikidpad">字段名称</b> </td><td class="wikidpad"><b class="wikidpad">字段类型</b> </td><td class="wikidpad"><b class="wikidpad">字段说明</b></td></tr>
<tr class="wikidpad"><td class="wikidpad">collect_timestamp </td><td class="wikidpad">bigint </td><td class="wikidpad">收藏时间戳</td></tr>
<tr class="wikidpad"><td class="wikidpad">type </td><td class="wikidpad">int </td><td class="wikidpad">收藏类型（0宝贝 1店铺）</td></tr>
<tr class="wikidpad"><td class="wikidpad">shop_id </td><td class="wikidpad">string </td><td class="wikidpad">店铺ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">auction_id </td><td class="wikidpad">string </td><td class="wikidpad">宝贝ID(店铺收藏此处留空)</td></tr>
<tr class="wikidpad"><td class="wikidpad">user_id </td><td class="wikidpad">string </td><td class="wikidpad">访客ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">ali_corp </td><td class="wikidpad">bigint </td><td class="wikidpad">网站类型（0 未知或非阿里系 1 淘宝 2 天猫 3 一淘 4 聚划算）</td></tr>
<tr class="wikidpad"><td class="wikidpad">collect_num </td><td class="wikidpad">int </td><td class="wikidpad">收藏次数</td></tr>
</table>

<li class="wikidpad" />购物车cart日志<br class="wikidpad" />
<table border="2" class="wikidpad">
<tr class="wikidpad"><td class="wikidpad"><b class="wikidpad">字段名称</b> </td><td class="wikidpad"><b class="wikidpad">字段类型</b> </td><td class="wikidpad"><b class="wikidpad">字段说明</b></td></tr>
<tr class="wikidpad"><td class="wikidpad">cart_timestamp </td><td class="wikidpad">bigint </td><td class="wikidpad">添加购物车时间戳</td></tr>
<tr class="wikidpad"><td class="wikidpad">shop_id </td><td class="wikidpad">string </td><td class="wikidpad">店铺ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">auction_id </td><td class="wikidpad">string </td><td class="wikidpad">宝贝ID(店铺收藏此处留空)</td></tr>
<tr class="wikidpad"><td class="wikidpad">user_id </td><td class="wikidpad">string </td><td class="wikidpad">访客ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">ali_corp </td><td class="wikidpad">bigint </td><td class="wikidpad">网站类型（0 未知或非阿里系 1 淘宝 2 天猫 3 一淘 4 聚划算）</td></tr>
<tr class="wikidpad"><td class="wikidpad">cart_num </td><td class="wikidpad">int </td><td class="wikidpad">购物车宝贝件数</td></tr>
</table>

<li class="wikidpad" />站外成交out_trade日志(没有宝贝件数，因为一淘从来不算)<br class="wikidpad" />
<table border="2" class="wikidpad">
<tr class="wikidpad"><td class="wikidpad"><b class="wikidpad">字段名称</b> </td><td class="wikidpad"><b class="wikidpad">字段类型</b> </td><td class="wikidpad"><b class="wikidpad">字段说明</b></td></tr>
<tr class="wikidpad"><td class="wikidpad">gmv_create_ori_ts </td><td class="wikidpad">bigint </td><td class="wikidpad">时间戳</td></tr>
<tr class="wikidpad"><td class="wikidpad">trade_no </td><td class="wikidpad">string </td><td class="wikidpad">交易号</td></tr>
<tr class="wikidpad"><td class="wikidpad">trade_track_info </td><td class="wikidpad">string </td><td class="wikidpad">订单跟踪id</td></tr>
<tr class="wikidpad"><td class="wikidpad">seller_id  </td><td class="wikidpad">string </td><td class="wikidpad">卖家ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">auction_id </td><td class="wikidpad">string </td><td class="wikidpad">宝贝ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">user_id </td><td class="wikidpad">string </td><td class="wikidpad">访客ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">gmv_trade_num </td><td class="wikidpad">int </td><td class="wikidpad">拍下笔数</td></tr>
<tr class="wikidpad"><td class="wikidpad">gmv_trade_amt </td><td class="wikidpad">float </td><td class="wikidpad">拍下金额</td></tr>
<tr class="wikidpad"><td class="wikidpad">pay_trade_num </td><td class="wikidpad">int </td><td class="wikidpad">成交比数</td></tr>
<tr class="wikidpad"><td class="wikidpad">pay_trade_amt </td><td class="wikidpad">float </td><td class="wikidpad">成交金额</td></tr>
</table>
</ol>

<li class="wikidpad" />输入单元的扩展属性<ul class="wikidpad bulletlist">
<li class="wikidpad" />每个表最后有两个附加字段useful_extra, extra。最终都会附加到产出表里<br class="wikidpad" />
<table border="2" class="wikidpad">
<tr class="wikidpad"><td class="wikidpad"><b class="wikidpad">字段名称</b> </td><td class="wikidpad"><b class="wikidpad">字段类型</b> </td><td class="wikidpad"><b class="wikidpad">字段说明</b></td></tr>
<tr class="wikidpad"><td class="wikidpad">useful_extra </td><td class="wikidpad">string </td><td class="wikidpad">使用key+ctrlC+value+ctrlB+...方式存储.key为字段名，value为内容</td></tr>
<tr class="wikidpad"><td class="wikidpad">extra </td><td class="wikidpad">string </td><td class="wikidpad">自身使用ctrl+B分割</td></tr>
</table>
</ul>

<li class="wikidpad" />最小输出单元<ul class="wikidpad bulletlist">
<li class="wikidpad" /><br class="wikidpad" />
<table border="2" class="wikidpad">
<tr class="wikidpad"><td class="wikidpad"><b class="wikidpad">字段名称</b> </td><td class="wikidpad"><b class="wikidpad">字段类型</b> </td><td class="wikidpad"><b class="wikidpad">字段说明</b></td></tr>
<tr class="wikidpad"><td class="wikidpad">index_root_path </td><td class="wikidpad">string </td><td class="wikidpad">路径列表 （留空）</td></tr>
<tr class="wikidpad"><td class="wikidpad">ts </td><td class="wikidpad">string </td><td class="wikidpad">时间戳</td></tr>
<tr class="wikidpad"><td class="wikidpad">analyzer_id </td><td class="wikidpad">bigint </td><td class="wikidpad">制定推广计划的用户ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">plan_id </td><td class="wikidpad">bigint </td><td class="wikidpad">推广计划ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">src </td><td class="wikidpad">string </td><td class="wikidpad">来源路径实例，可作为ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">url </td><td class="wikidpad">string </td><td class="wikidpad">url </td></tr>
<tr class="wikidpad"><td class="wikidpad">refer </td><td class="wikidpad">string </td><td class="wikidpad">refer url</td></tr>
<tr class="wikidpad"><td class="wikidpad">shop_id </td><td class="wikidpad">string </td><td class="wikidpad">店铺ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">auction_id </td><td class="wikidpad">string </td><td class="wikidpad">宝贝ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">user_id </td><td class="wikidpad">string </td><td class="wikidpad">访客ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">ali_corp </td><td class="wikidpad">bigint </td><td class="wikidpad">0 未知或非阿里系 1 淘宝 2 天猫 3 一淘 4 聚划算</td></tr>
<tr class="wikidpad"><td class="wikidpad">cookie </td><td class="wikidpad">string </td><td class="wikidpad">cookie用来标识一个访问用户（atpanle日志中用mid）</td></tr>
<tr class="wikidpad"><td class="wikidpad">session </td><td class="wikidpad">string </td><td class="wikidpad">一次会话的标识（atpanle日志中用sid）</td></tr>
<tr class="wikidpad"><td class="wikidpad">cookie2 </td><td class="wikidpad">string </td><td class="wikidpad">用来计算uv使用（atpanle日志中用mid_uid, 其他情况直接使用cookie）</td></tr>
<tr class="wikidpad"><td class="wikidpad">is_effect_page </td><td class="wikidpad">bigint </td><td class="wikidpad">是否为效果页 1为true</td></tr>
<tr class="wikidpad"><td class="wikidpad">ref_is_effect_page </td><td class="wikidpad">bigint </td><td class="wikidpad">是否为效果页下一跳 1为true</td></tr>
<tr class="wikidpad"><td class="wikidpad">is_leaf </td><td class="wikidpad">bigint </td><td class="wikidpad">是否为树的叶子节点 1为true</td></tr>
<tr class="wikidpad"><td class="wikidpad">jump_num </td><td class="wikidpad">int </td><td class="wikidpad">引导宝贝相对效果页跳数(从0开始，二期支持到4)</td></tr>
<tr class="wikidpad"><td class="wikidpad">index_type </td><td class="wikidpad">int </td><td class="wikidpad">指标类型标识(0非店铺, 1单品, 2单品同店, 3单店, 4淘外成交(仅etao才有), 5单品其他, 6单店其他)</td></tr>
<tr class="wikidpad"><td class="wikidpad">pv </td><td class="wikidpad">float </td><td class="wikidpad"></td></tr>
<tr class="wikidpad"><td class="wikidpad">gmv_amt </td><td class="wikidpad">float </td><td class="wikidpad">拍下金额</td></tr>
<tr class="wikidpad"><td class="wikidpad">gmv_auction_num </td><td class="wikidpad">float </td><td class="wikidpad">拍下件数</td></tr>
<tr class="wikidpad"><td class="wikidpad">gmv_trade_num </td><td class="wikidpad">float </td><td class="wikidpad">拍下笔数</td></tr>
<tr class="wikidpad"><td class="wikidpad">alipay_amt </td><td class="wikidpad">float </td><td class="wikidpad">成交金额</td></tr>
<tr class="wikidpad"><td class="wikidpad">alipay_auction_num </td><td class="wikidpad">float </td><td class="wikidpad">成交件数</td></tr>
<tr class="wikidpad"><td class="wikidpad">alipay_trade_num </td><td class="wikidpad">float </td><td class="wikidpad">成交笔数</td></tr>
<tr class="wikidpad"><td class="wikidpad">item_collect_num </td><td class="wikidpad">float </td><td class="wikidpad">收藏宝贝数</td></tr>
<tr class="wikidpad"><td class="wikidpad">shop_collect_num </td><td class="wikidpad">float </td><td class="wikidpad">收藏店铺数</td></tr>
<tr class="wikidpad"><td class="wikidpad">cart_auction_num </td><td class="wikidpad">float </td><td class="wikidpad">购物车宝贝数</td></tr>
</table>
</ul>

<li class="wikidpad" />输出单元的扩展属性<ul class="wikidpad bulletlist">
<li class="wikidpad" />2.0只支持浏览日志扩展字段的输出<br class="wikidpad" />
<table border="2" class="wikidpad">
<tr class="wikidpad"><td class="wikidpad"><b class="wikidpad">字段名称</b> </td><td class="wikidpad"><b class="wikidpad">字段类型</b> </td><td class="wikidpad"><b class="wikidpad">字段说明</b></td></tr>
<tr class="wikidpad"><td class="wikidpad">access_useful_extra </td><td class="wikidpad">string </td><td class="wikidpad">从输入直接继承</td></tr>
<tr class="wikidpad"><td class="wikidpad">access_extra </td><td class="wikidpad">string </td><td class="wikidpad">从输入直接继承</td></tr>
</table>
</ul>
</ol>
<a name="$8bbe$8ba1$6587$6863#.h6106" class="wikidpad"></a><h4 class="wikidpad heading-level4">8.1.hadoop任务之间数据交互规则</h4>
<ul class="wikidpad bulletlist">
<li class="wikidpad" />统一使用proto buf进行数据交互: LzEffect.proto （规则如下）</ul>
<pre style="background-color: #F7F9FA; border: 1px #8CACBB dashed; width: 80%; padding: 4px; margin: 2"><div class="source" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="background-color: #f0f0f0; padding: 0 5px 0 5px"> 0</span> <span style="color: #008000; font-weight: bold">package</span> lz<span style="color: #666666">.</span><span style="color: #7D9029">dw</span><span style="color: #666666">.</span><span style="color: #7D9029">effect</span><span style="color: #666666">.</span><span style="color: #7D9029">proto</span><span style="color: #666666">;</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px"> 1</span> 
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px"> 2</span>     option java_package <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;com.lz.dw.effect.proto&quot;</span><span style="color: #666666">;</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px"> 3</span>     option java_outer_classname <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;LzEffectProto&quot;</span><span style="color: #666666">;</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px"> 4</span> 
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px"> 5</span>     message TreeNodeValue<span style="color: #666666">{</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px"> 6</span>         message KeyValueS <span style="color: #666666">{</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px"> 7</span>                optional string key <span style="color: #666666">=</span> <span style="color: #666666">1;</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px"> 8</span>                optional string value <span style="color: #666666">=</span> <span style="color: #666666">2;</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px"> 9</span>         <span style="color: #666666">}</span> 
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">10</span>         message KeyValueI <span style="color: #666666">{</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">11</span>                optional string key <span style="color: #666666">=</span> <span style="color: #666666">1;</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">12</span>                optional int32 value <span style="color: #666666">=</span> <span style="color: #666666">2;</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">13</span>         <span style="color: #666666">}</span> 
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">14</span> 
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">15</span>         optional int64 ts <span style="color: #666666">=</span> <span style="color: #666666">1;</span> <span style="color: #408080; font-style: italic">// 日志的时间戳</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">16</span>         optional int32 log_type <span style="color: #666666">=</span> <span style="color: #666666">2;</span> <span style="color: #408080; font-style: italic">// 浏览 0  成交 1 收藏 2 站外成交 3 购物车 4</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">17</span>         
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">18</span>         optional string index_root_path <span style="color: #666666">=</span> <span style="color: #666666">3;</span> <span style="color: #408080; font-style: italic">// 树的root_path</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">19</span>         optional bool is_leaf <span style="color: #666666">=</span> <span style="color: #666666">4;</span> <span style="color: #408080; font-style: italic">// 是否为叶子节点</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">20</span>         optional bool is_root <span style="color: #666666">=</span> <span style="color: #666666">5;</span> <span style="color: #408080; font-style: italic">// 是否为根节点</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">21</span>         
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">22</span>         optional string url <span style="color: #666666">=</span> <span style="color: #666666">6;</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">23</span>         optional string refer <span style="color: #666666">=</span> <span style="color: #666666">7;</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">24</span>         optional string shop_id <span style="color: #666666">=</span> <span style="color: #666666">8;</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">25</span>         optional string auction_id <span style="color: #666666">=</span> <span style="color: #666666">9;</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">26</span>         optional string user_id <span style="color: #666666">=</span> <span style="color: #666666">10;</span> 
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">27</span>         optional int32 ali_corp <span style="color: #666666">=</span> <span style="color: #666666">11;</span> <span style="color: #408080; font-style: italic">// 页面属于4淘类型（0 未知或非阿里系 1 淘宝 2 天猫 3 一淘 4 聚划算）</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">28</span>         
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">29</span>         optional string cookie <span style="color: #666666">=</span> <span style="color: #666666">12;</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">30</span>         optional string session <span style="color: #666666">=</span> <span style="color: #666666">13;</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">31</span>         optional string cookie2 <span style="color: #666666">=</span> <span style="color: #666666">14;</span>  <span style="color: #408080; font-style: italic">// 计算uv使用字段</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">32</span>         
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">33</span>         message TypeRef <span style="color: #666666">{</span>  
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">34</span>            optional int32 analyzer_id <span style="color: #666666">=</span> <span style="color: #666666">1;</span>  <span style="color: #408080; font-style: italic">// 用户id</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">35</span>            optional int32 plan_id <span style="color: #666666">=</span> <span style="color: #666666">2;</span>  <span style="color: #408080; font-style: italic">// 计划id</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">36</span>            
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">37</span>            optional bool is_matched <span style="color: #666666">=</span> <span style="color: #666666">3;</span> <span style="color: #408080; font-style: italic">// url match是否匹配</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">38</span>            optional int32 rtype <span style="color: #666666">=</span> <span style="color: #666666">4;</span> <span style="color: #408080; font-style: italic">// 页面的父节点类型id</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">39</span>            optional int32 ptype <span style="color: #666666">=</span> <span style="color: #666666">5;</span>  <span style="color: #408080; font-style: italic">// 页面类型id</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">40</span>            repeated KeyValueI source_info <span style="color: #666666">=</span> <span style="color: #666666">6;</span> <span style="color: #408080; font-style: italic">// 保存match属性类型，对应PTLogEntry的source</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">41</span>            repeated KeyValueS captured_info <span style="color: #666666">=</span> <span style="color: #666666">7;</span> <span style="color: #408080; font-style: italic">// 保存match属性结果，对应PTLogEntry的captured</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">42</span>            
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">43</span>            message TypePathInfo <span style="color: #666666">{</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">44</span>                optional string src <span style="color: #666666">=</span> <span style="color: #666666">1;</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">45</span>                optional int64 first_ts <span style="color: #666666">=</span> <span style="color: #666666">2;</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">46</span>                optional int64 last_ts <span style="color: #666666">=</span> <span style="color: #666666">3;</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">47</span>                optional int32 priority <span style="color: #666666">=</span> <span style="color: #666666">4;</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">48</span>                optional bool is_effect_page <span style="color: #666666">=</span> <span style="color: #666666">5;</span> <span style="color: #408080; font-style: italic">// true 是效果页</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">49</span>                optional bool ref_is_effect_page <span style="color: #666666">=</span> <span style="color: #666666">6;</span> <span style="color: #408080; font-style: italic">// true 是效果页下一跳</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">50</span>                optional int32 first_guide_jump_num <span style="color: #666666">=</span> <span style="color: #666666">7;</span> <span style="color: #408080; font-style: italic">// 首次被引导页面的跳数</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">51</span>                optional string first_guide_auction_id <span style="color: #666666">=</span> <span style="color: #666666">8;</span> <span style="color: #408080; font-style: italic">// 首次被引导页面的宝贝ID</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">52</span>                optional string first_guide_shop_id <span style="color: #666666">=</span> <span style="color: #666666">9;</span> <span style="color: #408080; font-style: italic">// 首次被引导页面的店铺ID</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">53</span>                optional int32 last_guide_jump_num <span style="color: #666666">=</span> <span style="color: #666666">10;</span> <span style="color: #408080; font-style: italic">// 末次被引导页面的跳数</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">54</span>                optional string last_guide_auction_id <span style="color: #666666">=</span> <span style="color: #666666">11;</span> <span style="color: #408080; font-style: italic">// 末次被引导页面的宝贝ID</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">55</span>                optional string last_guide_shop_id <span style="color: #666666">=</span> <span style="color: #666666">12;</span> <span style="color: #408080; font-style: italic">// 末次被引导页面的店铺ID</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">56</span>            <span style="color: #666666">}</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">57</span>            repeated TypePathInfo path_info <span style="color: #666666">=</span> <span style="color: #666666">8;</span> <span style="color: #408080; font-style: italic">// 来源路径信息</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">58</span>         <span style="color: #666666">}</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">59</span>         repeated TypeRef type_ref <span style="color: #666666">=</span> <span style="color: #666666">15;</span> <span style="color: #408080; font-style: italic">// 节点的对于特定plan的附加属性信息</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">60</span>         
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">61</span>         repeated KeyValueS access_useful_extra <span style="color: #666666">=</span> <span style="color: #666666">16;</span> 
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">62</span>         optional string access_extra <span style="color: #666666">=</span> <span style="color: #666666">17;</span>
<span style="background-color: #f0f0f0; padding: 0 5px 0 5px">63</span>     <span style="color: #666666">}</span>
</pre></div>
</pre><ul class="wikidpad bulletlist">
<li class="wikidpad" />提供LzEffectProtoUtil类，提供两种序列化方法<ul class="wikidpad bulletlist">
<li class="wikidpad" />二进制序列化: serialize, deserialize
<li class="wikidpad" />字符串序列化：toString, fromString</ul>

<li class="wikidpad" />不需要的字段不需要添加内容</ul>
<a name="$8bbe$8ba1$6587$6863#.h8985" class="wikidpad"></a><h4 class="wikidpad heading-level4">8.2.单元测试</h4>
<ul class="wikidpad bulletlist">
<li class="wikidpad" />MR任务全部使用MRUnit进行单元测试。</ul>
<a name="$8bbe$8ba1$6587$6863#.h9027" class="wikidpad"></a><h4 class="wikidpad heading-level4">8.3.调度使用方法</h4>
<ul class="wikidpad bulletlist">
<li class="wikidpad" />参数： "Usage : EffectOwnership [InputAccessPath] [OutputPath] [config_paths] [numOfMappers] [numOfReducers] [mid_path]   &lt;gmv=GmvLogPath&gt; &lt;collect=CollectLogPath&gt; &lt;period=1(归属周期，默认1)&gt; &lt;tree_split=none(默认)&gt; &lt;runner_job=1/2&gt; &lt;files=(本地路径)&gt;</ul>
<a name="$8bbe$8ba1$6587$6863#.h9285" class="wikidpad"></a><h4 class="wikidpad heading-level4">8.4.特殊指标定义</h4>
<ul class="wikidpad bulletlist">
<li class="wikidpad" />被引导页面的宝贝/店铺ID获取方法：<ul class="wikidpad bulletlist">
<li class="wikidpad" />从效果页开始，查看效果页是否有auction_id/shop_id。有则填写jump_num=0
<li class="wikidpad" />效果页没有则看效果页下一跳是否有auction_id/shop_id。有则填写jump_num=1
<li class="wikidpad" />以此类推，一直到jump_num=4为止，还没有的话则不填写引导宝贝/店铺信息。jump_num=-1。</ul>
</ul>
<a name="$8bbe$8ba1$6587$6863#.h9508" class="wikidpad"></a><h4 class="wikidpad heading-level4">8.5.详细计算流程</h4>
<a name="$8bbe$8ba1$6587$6863#.h9524" class="wikidpad"></a><h5 class="wikidpad heading-level5">job1:URL MATCHER &amp; Forest &amp; Colorized</h5>
<ol class="wikidpad orderedlist">
<li class="wikidpad" />类： com.lz.dw.effect.EffectNodeFinder
<li class="wikidpad" />开发设计:<ol class="wikidpad orderedlist">
<li class="wikidpad" />map阶段完成 url matcher 任务。<ul class="wikidpad bulletlist">
<li class="wikidpad" />调用URLMatcher.java模块【呜柯】, 获取type_ref, ali_corp信息
<li class="wikidpad" />key = new TextPair(new Text(mid+"_"+sid), new Text(ts))
<li class="wikidpad" />value = LzEffect.proto</ul>

<li class="wikidpad" />sort &amp; partition<ul class="wikidpad bulletlist">
<li class="wikidpad" />mid+"_"+sid 分组， ts 顺序</ul>

<li class="wikidpad" />reduce阶段完成 forest &amp; colorized 部分<ul class="wikidpad bulletlist">
<li class="wikidpad" />调用外部模块【清无＆民瞻】，参见清无文档3.1
<li class="wikidpad" />只有染色节点才输出数据
<li class="wikidpad" />key = new Text("")
<li class="wikidpad" />value = LzEffect.proto (toString)</ul>
</ol>
</ol>
<a name="$8bbe$8ba1$6587$6863#.h10079" class="wikidpad"></a><h5 class="wikidpad heading-level5">job2:EFFECT OWNERSHIP</h5>
<ol class="wikidpad orderedlist">
<li class="wikidpad" />类： com.lz.dw.effect.EffectOwnership 
<li class="wikidpad" />开发设计:<ol class="wikidpad orderedlist">
<li class="wikidpad" />map阶段<ul class="wikidpad bulletlist">
<li class="wikidpad" />对浏览日志，成交日志进行ETL<ul class="wikidpad bulletlist">
<li class="wikidpad" />浏览日志仅保留已经标颜色的部分
<li class="wikidpad" />成交全部保留</ul>

<li class="wikidpad" />key = new TextPair(user_id, ts)
<li class="wikidpad" />value = LzEffect.proto</ul>

<li class="wikidpad" />sort &amp; partition<ul class="wikidpad bulletlist">
<li class="wikidpad" />user_id, auction_id 分组， ts 倒序</ul>

<li class="wikidpad" />reduce阶段<ul class="wikidpad bulletlist">
<li class="wikidpad" />通过 <b class="wikidpad">同优先级来源效果归属规则</b> <b class="wikidpad">成交效果归属逻辑</b> 进行归属
<li class="wikidpad" />保留成交list，按归属规则找到其他店铺path_info，间接成交path_info，直接成交path_info。最终把成交属性附加到某个树节点中。</ul>
</ol>
</ol>
<a name="$8bbe$8ba1$6587$6863#.h10578" class="wikidpad"></a><h4 class="wikidpad heading-level4">8.6:性能优化方案 </h4>
<ol class="wikidpad orderedlist">
<li class="wikidpad" />方案<ul class="wikidpad bulletlist">
<li class="wikidpad" />Finder时reduce先把session存入队列，如果是否有效果页is_matched=true进行建树处理，否则抛弃。
<li class="wikidpad" />Finder时reduce先把session存入对垒，按照plan多少进行多次重复建树操作。完成一次输出一次。（因为染色节点毕竟是少数，所以产出条数会减少很多）</ul>

<li class="wikidpad" />提升效果 <ul class="wikidpad bulletlist">
<li class="wikidpad" />TODO<br class="wikidpad" />
</ul>
</ol>
<a name="$8bbe$8ba1$6587$6863#.h10816" class="wikidpad"></a><h3 class="wikidpad heading-level3">9.数据计算</h3>
<img src="离线计算流程图.png"></img><br class="wikidpad" />
<a name="$8bbe$8ba1$6587$6863#.h10857" class="wikidpad"></a><h5 class="wikidpad heading-level5">9.1.ETL操作</h5>
<ol class="wikidpad orderedlist">
<li class="wikidpad" />流量日志<ul class="wikidpad bulletlist">
<li class="wikidpad" />规则：refer like '/1.gif%' 
<li class="wikidpad" />上游：r_atpanel_log 
<li class="wikidpad" />产出：lz_fact_ep_browse_log 
<li class="wikidpad" />分区：dt=20120603, logsrc='atpanel'</ul>

<li class="wikidpad" />点击日志<ul class="wikidpad bulletlist">
<li class="wikidpad" />规则：url like '%ju.atpanel.com%' and url like '%tb_market_id%' and not refer like '/1.gif%' 
<li class="wikidpad" />上游：r_atpanel_log 
<li class="wikidpad" />产出：lz_fact_ep_ad_click_log 
<li class="wikidpad" />分区：dt=20120603, logsrc='atpanel'</ul>

<li class="wikidpad" />成交日志<ul class="wikidpad bulletlist">
<li class="wikidpad" />必须字段：gmv_ts(拍下时间戳), alipay_ts, shop_id, auction_id, user_id, gmv_amt, gmv_auction_num, alipay_amt, alipay_auction_num, ali_corp
<li class="wikidpad" />上游：lz_fact_user_trade, r_bmw_shops(lz_dim_sellers)
<li class="wikidpad" />产出：lz_fact_ep_trade_info 
<li class="wikidpad" />分区：dt=20120603, round=1, logsrc='taobao'</ul>

<li class="wikidpad" />表<b class="wikidpad">详情见Power Designer</b></ol>
<a name="$8bbe$8ba1$6587$6863#.h11635" class="wikidpad"></a><h5 class="wikidpad heading-level5">9.2 输出中间表</h5>
<ul class="wikidpad bulletlist">
<li class="wikidpad" />输出中间表lz_fact_ep_ownership, 参见 [核心计算模块]</ul>
<a name="$8bbe$8ba1$6587$6863#.h11693" class="wikidpad"></a><h5 class="wikidpad heading-level5">9.3.效果指标计算</h5>
<ol class="wikidpad orderedlist">
<li class="wikidpad" />需要关联点击日志，汇总点击数据
<li class="wikidpad" />最终结果<ul class="wikidpad bulletlist">
<li class="wikidpad" />plan_id, day, dim, 指标
<li class="wikidpad" />plan_id, day, dim, src_id, src_ext, path_id, 指标
<li class="wikidpad" />指标有如下：<span class="wikidpad url-link"><a href="http://red.lzdp.us/projects/effect-platform/wiki/_Effect_Sprint1_Design_index" class="wikidpad">http://red.lzdp.us/projects/effect-platform/wiki/_Effect_Sprint1_Design_index</a></span>
<li class="wikidpad" />可以汇总为：广告位3个指标，效果页5个指标， 效果指标42个（效果页含不同页面前端可适配）。</ul>
</ol>
<a name="$8bbe$8ba1$6587$6863#.h12008" class="wikidpad"></a><h5 class="wikidpad heading-level5">9.4. 广告点击数据处理</h5>
<ol class="wikidpad orderedlist">
<li class="wikidpad" />开发设计:
<li class="wikidpad" />参数: [InputPath] [OutputPath] [numOfMappers] [numOfReducers] [config_paths]
<li class="wikidpad" />进行广告点击数据的计算
<li class="wikidpad" />表1：lz_fact_ep_ad_click_info_temp</ol>
<table border="2" class="wikidpad MyStyle">
<tr class="wikidpad"><td class="wikidpad"><b class="wikidpad">字段名称</b> </td><td class="wikidpad"><b class="wikidpad">字段类型</b> </td><td class="wikidpad"><b class="wikidpad">字段说明</b></td></tr>
<tr class="wikidpad"><td class="wikidpad">ts </td><td class="wikidpad">string </td><td class="wikidpad"></td></tr>
<tr class="wikidpad"><td class="wikidpad">analyzer_id </td><td class="wikidpad">bigint </td><td class="wikidpad">制定推广计划的用户ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">plan_id </td><td class="wikidpad">bigint </td><td class="wikidpad">推广计划ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">adid </td><td class="wikidpad">string </td><td class="wikidpad">外投广告id</td></tr>
<tr class="wikidpad"><td class="wikidpad">cookie </td><td class="wikidpad">string </td><td class="wikidpad">用来计算uv（取自mid_uid 有uid就是uid，没有就是mid）</td></tr>
<tr class="wikidpad"><td class="wikidpad">pv </td><td class="wikidpad">float </td><td class="wikidpad"></td></tr>
</table>
<ol class="wikidpad orderedlist">
<li class="wikidpad" />表2：lz_fact_ep_ad_click_info</ol>
<table border="2" class="wikidpad">
<tr class="wikidpad"><td class="wikidpad"><b class="wikidpad">字段名称</b> </td><td class="wikidpad"><b class="wikidpad">字段类型</b> </td><td class="wikidpad"><b class="wikidpad">字段说明</b></td></tr>
<tr class="wikidpad"><td class="wikidpad">ts </td><td class="wikidpad">string </td><td class="wikidpad"></td></tr>
<tr class="wikidpad"><td class="wikidpad">analyzer_id </td><td class="wikidpad">bigint </td><td class="wikidpad">制定推广计划的用户ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">plan_id </td><td class="wikidpad">bigint </td><td class="wikidpad">推广计划ID</td></tr>
<tr class="wikidpad"><td class="wikidpad">adid </td><td class="wikidpad">string </td><td class="wikidpad">外投广告id</td></tr>
<tr class="wikidpad"><td class="wikidpad">pv </td><td class="wikidpad">float </td><td class="wikidpad"></td></tr>
<tr class="wikidpad"><td class="wikidpad">uv </td><td class="wikidpad">float </td><td class="wikidpad"></td></tr>
</table>
<a name="$8bbe$8ba1$6587$6863#.h12596" class="wikidpad"></a><h5 class="wikidpad heading-level5">9.5. 广告数据mysql入库</h5>
<ol class="wikidpad orderedlist">
<li class="wikidpad" />导入r_act_media_adid_site表到前端mysql
<li class="wikidpad" />表：lz_fact_ep_ad_config</ol>
<table border="2" class="wikidpad">
<tr class="wikidpad"><td class="wikidpad"><b class="wikidpad">字段名称</b> </td><td class="wikidpad"><b class="wikidpad">字段类型</b> </td><td class="wikidpad"><b class="wikidpad">字段说明</b></td></tr>
<tr class="wikidpad"><td class="wikidpad">ad_id </td><td class="wikidpad">string </td><td class="wikidpad">外投广告id</td></tr>
<tr class="wikidpad"><td class="wikidpad">ad_site_name </td><td class="wikidpad">string </td><td class="wikidpad"></td></tr>
<tr class="wikidpad"><td class="wikidpad">ad_page_name </td><td class="wikidpad">string </td><td class="wikidpad"></td></tr>
<tr class="wikidpad"><td class="wikidpad">ad_position_name </td><td class="wikidpad">string </td><td class="wikidpad"></td></tr>
<tr class="wikidpad"><td class="wikidpad">ad_creative_name </td><td class="wikidpad">string </td><td class="wikidpad"></td></tr>
<tr class="wikidpad"><td class="wikidpad">ad_activity_name </td><td class="wikidpad">string </td><td class="wikidpad"></td></tr>
<tr class="wikidpad"><td class="wikidpad">ad_activity_id </td><td class="wikidpad">string </td><td class="wikidpad"></td></tr>
</table>
<a name="$8bbe$8ba1$6587$6863#.h12910" class="wikidpad"></a><h5 class="wikidpad heading-level5">9.6. 结果数据导入到hbase</h5>
<ol class="wikidpad orderedlist">
<li class="wikidpad" />hbase定义见清无设计文档
<li class="wikidpad" />进行业务指标到hbase的指标映射。hbase指标id可参见：<span class="wikidpad url-link"><a href="http://red.lzdp.us/projects/effect-platform/wiki/_Effect_Sprint1_Design_index" class="wikidpad">http://red.lzdp.us/projects/effect-platform/wiki/_Effect_Sprint1_Design_index</a></span>
<li class="wikidpad" />例子：<ul class="wikidpad bulletlist">
<li class="wikidpad" />如direct_pv 需映射到：200，405
<li class="wikidpad" />如indirect_pv 需映射到：211，300，416</ul>
</ol>
<a name="$8bbe$8ba1$6587$6863#.h13174" class="wikidpad"></a><h3 class="wikidpad heading-level3">10.SPM信息</h3>
* 站点ID信息：s_spm_site<br class="wikidpad" />
* 页面信息: s_spm_page<br class="wikidpad" />
* 模块信息: s_spm_module<br class="wikidpad" />
* 位置信息: <br class="wikidpad" />
<br class="wikidpad" />
<br class="wikidpad" />
<br class="wikidpad" />
<br class="wikidpad" />
<br class="wikidpad" />
<br class="wikidpad" />
<br class="wikidpad" />
<br class="wikidpad" />
<br class="wikidpad" />
<hr class="wikidpad" />    </body>
</html>
